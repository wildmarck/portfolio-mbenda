name: CI/CD Pipeline - Portfolio

# D√©clencheurs : Quand est-ce que ce pipeline s'active ?
# 1. √Ä chaque push sur la branche main
# 2. √Ä chaque Pull Request vers main (pour tester avant de fusionner)
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # --- JOB 1 : CONTR√îLE QUALIT√â ---
  quality-gate:
    name: üõ°Ô∏è Terraform & Code Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installation de Terraform
        uses: hashicorp/setup-terraform@v3

      # V√©rifie si le code Terraform est bien format√©
      # Si tu as oubli√© "terraform fmt" en local, √ßa plantera ici !
      - name: V√©rification du formatage Terraform
        run: terraform fmt -check

  # --- JOB 2 : LIVRAISON DOCKER (MODERNE) ---
  docker-delivery:
    name: üê≥ Build & Push Docker Hub
    needs: quality-gate # Attend que le contr√¥le qualit√© soit vert
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Connexion √† Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build et Push de l'image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # On taggue avec "latest" ET avec le SHA du commit (versioning pr√©cis)
          tags: |
            wildmarckgamming/portfolio:latest
            wildmarckgamming/portfolio:${{ github.sha }}

  # --- JOB 3 : D√âPLOIEMENT FTP (LEGACY) ---
  legacy-deploy:
    name: üöÄ Deploy to InfinityFree (FTP)
    needs: quality-gate # Attend aussi le contr√¥le qualit√©
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Envoi des fichiers via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          # InfinityFree demande souvent de mettre les fichiers dans "htdocs"
          server-dir: /htdocs/ 
          # Attention : Si ton site est dans un sous-dossier local, change "./" ci-dessous
          local-dir: ./ 
          protocol: ftp
          exclude: |
            **/.git*
            **/.github*
            **/Dockerfile
            **/main.tf
            **/README.md